---
title: Стрелялки
---
## Стрелялки
### Что это такое?
Под "танком" подразумевается как железная, так и софтовая составляющая
пушки-инструмента, который:
 * конфигурируется нужным образом
 * делает запросы в соответствии со схемой нагрузки
 * получает ответы
 * проводит аналитику
 * считает посекундные агрегаты по данным теста
 * корректирует текущую нагрузку в соответствии со схемой нагрузки
 * загружает данные в отчётилку

Обычно используем для тестов yandex-tank, подключая разные пушки, потому
что это инструмент, позволяющий универсально использовать любые пушки и
получать данные о результатах в едином формате.

Выбор пушки зависит от типа нагрузки, который необходимо подавать на
тестируемый сервис.

Пушки бывают двух типов, hit-based и scenario-based.

#### hit based
Режим стрельбы запросами в RPS, в подавляющем большинстве случаев по
stateless протоколу, анализ результатов происходит по каким-то простым
assert'ам (например, протокольные коды ответов). Как правило, за счёт
своей простоты, этот тип пушек самый быстрый и производительный пушка.

#### scenario-based
Режим стрельбы сценариями, когда для последующих запросов в сценарии
нужны данные из результатов предыдущих запросов. Для этого необходимо
как-то парсить ответы, сохранять данные в структуры и использовать их.
Это всё замедляет работу пушки и она ощутимо медленнее, чем hit-based.

### Какие бывают
Пушек есть много разных и они все разные.

#### Pandora
hit-based пушка на Go, поддерживает кастомные пушки для scenario-based. 

Из-за особенностей лёгкий тредов Go, быстрая, до 100k rps
http/keep-alive с машинки. 

Это наша основная пушка, у нас есть примеры кастомных пушек на пандоре
(в том числе gRPC и websockets).

#### Phantom
Стабильная быстрая пушка на с++ (40k rps~ с машинки), которые отлично
стреляет в http, хороший hit-based, scenario-based не поддерживается.
https стреляет, но с ограничениями в 400-500 handshake'ов в секунду.

#### JMeter
Пушка на Java, производительность scenario-based зависит от сложности
работы сценария, используя плагин throughput shaping timer можно сделать
из неё hit-based пушку. Поддерживает http/https, существует большое
количество плагинов для стрельб в разные сервисы.

#### BFG
Сценарная пушка на python. Не очень производительная, на python
multiprocessing+multithreading, от 3 до 10k rps с машинки.

Однако, позволяет писать произвольный код и стрелять им. Даже
функциональными тестами, что довольно удобно, когда нужно внезапно
нагрузочно потестировать, базы данных или огромную state-машину,
к которой существуют функциональные тесты, постоянно поддерживаемые
в актуальном состоянии боевыми товарищами из QA.

Подключаешь python клиент, делаешь вызов, Bfg их распараллеливает по
процессам в соответствии с расписанием.

#### Своя на базе pandora
Если вам требуется потестировать какой-то сложный сценарий работы вашего
сервиса, например, потестировать websockets или gRPC, то на базе пушки
pandora можно собрать [любую свою пушку](custom.html).


### Как сделать свою железку
Если вы хотите поднять локальный танк, чтобы просто пострелять
и подебажить, можно взять наш docker образ. Это минимальный набор пушек
и софта (yandex-tank/pandora), необходимый для ручных стрельб.

[пример Dockerfile](https://github.com/x-yield/performance/blob/master/docker/Dockerfile.tank)


### Как управлять танком удалённо
#### Tank API
Для удалённого управления танками используем
[tank API](https://github.com/load-tools/yandex-tank-api)

Он позволяет узнать в каком состоянии сейчас танк, какие тесты запущены
и в каком они состоянии.

Помимо этого, можно валидировать конфиги теста (чтобы заранее узнать,
что тест не запустится, если конфиг написан неправильно).

Помимо этого, можно запускать "подготовку" теста - prepare - чтобы
танк принял конфиг, прочитал его, подготовился к стрельбе (иногда это
занимает значительный промежуток времени) и ожидал команды "стрелять".
Такой режим работы нужен для одновременного запуска нескольких
распределённых танков.

Докер образ с API+tank:
[пример Dockerfile](https://github.com/x-yield/performance/blob/master/docker/Dockerfile.tankapi)

##### Как запускать
По-дефолту, он поднимается на порту `8888`. Используя докер образ выше,
можно expose'ить другие порты, например, так:
```
docker run -p 8124:8888 tankapi-image
```

##### Ручки tankAPI
Подробности по работе с tank API, какие есть ручки и как с ними работать
можно читать [тут](https://github.com/load-tools/yandex-tank-api/blob/dev/README.md)
